name: Validate Plugins

on:
  push:
    branches: [main]
    paths:
      - 'pr-patrol/**'
      - 'spec-interview/**'
      - '.claude-plugin/**'
  pull_request:
    paths:
      - 'pr-patrol/**'
      - 'spec-interview/**'
      - '.claude-plugin/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Validate marketplace.json
        run: |
          echo "Checking marketplace.json..."
          jq empty .claude-plugin/marketplace.json || {
            echo "ERROR: Invalid JSON in marketplace.json"
            exit 1
          }

          # Check required fields
          name=$(jq -r '.name' .claude-plugin/marketplace.json)
          owner=$(jq -r '.owner.name' .claude-plugin/marketplace.json)

          if [ "$name" == "null" ] || [ "$owner" == "null" ]; then
            echo "ERROR: Missing required fields in marketplace.json"
            exit 1
          fi
          echo "marketplace.json OK"

      - name: Validate plugin manifests
        run: |
          for plugin in pr-patrol spec-interview; do
            echo "Validating $plugin/plugin.json..."

            manifest="$plugin/.claude-plugin/plugin.json"
            if [ ! -f "$manifest" ]; then
              echo "ERROR: Missing $manifest"
              exit 1
            fi

            jq empty "$manifest" || {
              echo "ERROR: Invalid JSON in $manifest"
              exit 1
            }

            # Check required fields
            name=$(jq -r '.name' "$manifest")
            version=$(jq -r '.version' "$manifest")

            if [ "$name" == "null" ]; then
              echo "ERROR: Missing 'name' in $manifest"
              exit 1
            fi

            if [ "$version" == "null" ]; then
              echo "ERROR: Missing 'version' in $manifest"
              exit 1
            fi

            # Validate semantic versioning
            if ! [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "ERROR: Invalid version format '$version' (expected x.y.z)"
              exit 1
            fi

            echo "$plugin OK (v$version)"
          done

      - name: Validate directory structure
        run: |
          for plugin in pr-patrol spec-interview; do
            echo "Checking structure of $plugin..."

            # .claude-plugin must exist
            if [ ! -d "$plugin/.claude-plugin" ]; then
              echo "ERROR: Missing .claude-plugin directory in $plugin"
              exit 1
            fi

            # Components must NOT be inside .claude-plugin
            for dir in commands agents skills hooks; do
              if [ -d "$plugin/.claude-plugin/$dir" ]; then
                echo "ERROR: $dir should be at $plugin root, not inside .claude-plugin"
                exit 1
              fi
            done

            echo "$plugin structure OK"
          done

      - name: Check for secrets
        run: |
          echo "Scanning for hardcoded secrets..."
          if grep -rE "(ANTHROPIC_API_KEY|AWS_SECRET|PRIVATE_KEY|sk-[a-zA-Z0-9]{20,})" \
             --include="*.md" --include="*.json" --include="*.sh" \
             pr-patrol spec-interview 2>/dev/null; then
            echo "ERROR: Potential secrets detected!"
            exit 1
          fi
          echo "No secrets found"

      - name: Validate YAML frontmatter in commands
        run: |
          echo "Checking YAML frontmatter..."
          find pr-patrol spec-interview \( -path "*/commands/*.md" -o -path "*/agents/*.md" \) -print0 2>/dev/null | while IFS= read -r -d '' file; do
            # Check if file starts with ---
            if head -1 "$file" | grep -q "^---$"; then
              # Count --- occurrences (should be at least 2)
              count=$(grep -c "^---$" "$file" || true)
              if [ "$count" -lt 2 ]; then
                echo "WARNING: Incomplete frontmatter in $file"
              fi
            fi
          done
          echo "Frontmatter check complete"

      - name: Validate script permissions
        run: |
          echo "Checking script permissions..."
          find pr-patrol -name "*.sh" -print0 2>/dev/null | while IFS= read -r -d '' script; do
            if [ ! -x "$script" ]; then
              echo "WARNING: $script is not executable"
            fi
          done
          echo "Script check complete"

      - name: Summary
        run: |
          echo ""
          echo "=== Validation Summary ==="
          echo "pr-patrol: $(jq -r '.version' pr-patrol/.claude-plugin/plugin.json)"
          echo "spec-interview: $(jq -r '.version' spec-interview/.claude-plugin/plugin.json)"
          echo "All checks passed!"
